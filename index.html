<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥µé€Ÿè³½é¦¬ - æ’åçµç®—ç‰ˆ</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", sans-serif;
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #e0e0e0;
            overflow: hidden;
        }

        .game-container {
            background: #2d2d2d;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            width: 95%;
            max-width: 850px;
            position: relative;
        }

        h1 { text-align: center; color: #ffcc00; margin: 0 0 15px 0; font-size: 28px; }

        .status-bar {
            background: #3d3d3d;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            border-left: 5px solid #ffcc00;
        }

        .track-area {
            background: #222;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .track {
            height: 60px;
            border-bottom: 1px solid #333;
            position: relative;
            display: flex;
            align-items: center;
        }

        .horse-label { width: 60px; font-weight: bold; color: #888; text-align: center; font-size: 14px; }

        .horse-emoji {
            position: absolute;
            left: 60px;
            font-size: 35px;
            transition: left 0.1s linear;
            z-index: 2;
        }

        .finish-line {
            position: absolute;
            right: 0;
            height: 100%;
            width: 8px;
            background: repeating-linear-gradient(0deg, #ffcc00, #ffcc00 10px, #000 10px, #000 20px);
        }

        .bet-selection {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .horse-btn {
            background: #3d3d3d;
            color: white;
            border: 2px solid #555;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            flex: 1;
            font-weight: bold;
        }

        .horse-btn.active {
            border-color: #ffcc00;
            background: #554400;
            transform: translateY(-2px);
        }

        .input-panel {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        input {
            background: #444;
            color: white;
            border: 1px solid #666;
            padding: 10px;
            border-radius: 5px;
            width: 100px;
            font-size: 16px;
        }

        #startBtn {
            background: #e67e22;
            color: white;
            padding: 10px 25px;
            font-size: 16px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        #startBtn:disabled { background: #555; }

        .log-area {
            margin-top: 15px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        #gameLog { font-size: 18px; font-weight: bold; margin-bottom: 8px; text-align: center; }

        .ranking-list {
            display: flex;
            gap: 10px;
            font-size: 14px;
            color: #aaa;
            margin-top: 5px;
        }

        .ranking-item {
            background: #333;
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid #444;
        }

        .countdown {
            font-size: 40px;
            color: #ffcc00;
            font-weight: bold;
            display: none;
        }

        #confetti-canvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 999;
        }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div class="game-container">
    <h1>ğŸ DARK RACE è³½é¦¬ç†è²¡</h1>
    
    <div class="status-bar">
        <span>è³‡ç”¢: $<span id="balance">1000</span></span>
        <span style="color: #ffcc00;">â˜… æ’åçµç®—ç‰ˆ â˜…</span>
    </div>

    <div class="track-area">
        <div class="track"><div class="horse-label">1 è™Ÿ</div><div id="horse0" class="horse-emoji">ğŸ</div><div class="finish-line"></div></div>
        <div class="track"><div class="horse-label">2 è™Ÿ</div><div id="horse1" class="horse-emoji">ğŸ</div><div class="finish-line"></div></div>
        <div class="track"><div class="horse-label">3 è™Ÿ</div><div id="horse2" class="horse-emoji">ğŸ</div><div class="finish-line"></div></div>
        <div class="track"><div class="horse-label">4 è™Ÿ</div><div id="horse3" class="horse-emoji">ğŸ</div><div class="finish-line"></div></div>
    </div>

    <div class="bet-selection">
        <button class="horse-btn active" onclick="selectHorse(0)">1è™Ÿé¦¬</button>
        <button class="horse-btn" onclick="selectHorse(1)">2è™Ÿé¦¬</button>
        <button class="horse-btn" onclick="selectHorse(2)">3è™Ÿé¦¬</button>
        <button class="horse-btn" onclick="selectHorse(3)">4è™Ÿé¦¬</button>
    </div>

    <div class="input-panel">
        <input type="number" id="betAmount" placeholder="ä¸‹æ³¨é¡" min="1" value="100">
        <button id="startBtn" onclick="initCountdown()">æº–å‚™é–‹è·‘</button>
    </div>

    <div class="log-area">
        <div id="countdown" class="countdown">3</div>
        <div id="gameLog">è«‹é¸æ“‡é¦¬åŒ¹ä¸¦ä¸‹æ³¨</div>
        <div id="rankingArea" class="ranking-list"></div>
    </div>
</div>

<script>
    let playerMoney = 1000;
    let selectedHorse = 0;
    let isRacing = false;

    // --- ç´™å±‘ç‰¹æ•ˆ ---
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    let pieces = [];
    function updateCanvasSize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', updateCanvasSize);
    updateCanvasSize();

    function createConfetti() {
        for (let i = 0; i < 80; i++) {
            pieces.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                size: Math.random() * 8 + 4,
                color: `hsl(${Math.random() * 360}, 70%, 60%)`,
                speed: Math.random() * 4 + 2,
                angle: Math.random() * 6.28
            });
        }
    }

    function drawConfetti() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        pieces.forEach((p, i) => {
            p.y += p.speed; p.angle += 0.1;
            ctx.fillStyle = p.color;
            ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.angle);
            ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
            ctx.restore();
            if (p.y > canvas.height) pieces.splice(i, 1);
        });
        if (pieces.length > 0) requestAnimationFrame(drawConfetti);
    }

    // --- éŠæˆ²é‚è¼¯ ---
    function selectHorse(index) {
        if (isRacing) return;
        selectedHorse = index;
        document.querySelectorAll('.horse-btn').forEach((btn, i) => btn.classList.toggle('active', i === index));
    }

    function initCountdown() {
        const amt = parseInt(document.getElementById('betAmount').value);
        if (isNaN(amt) || amt <= 0 || amt > playerMoney) { alert("é¤˜é¡ä¸è¶³æˆ–é‡‘é¡ç„¡æ•ˆï¼"); return; }

        isRacing = true;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('gameLog').innerText = "";
        document.getElementById('rankingArea').innerHTML = "";
        const cdDiv = document.getElementById('countdown');
        cdDiv.style.display = 'block';

        let count = 3;
        cdDiv.innerText = count;
        const timer = setInterval(() => {
            count--;
            if (count > 0) cdDiv.innerText = count;
            else if (count === 0) cdDiv.innerText = "GO!";
            else {
                clearInterval(timer);
                cdDiv.style.display = 'none';
                startRace(amt);
            }
        }, 800);
    }

    function startRace(betAmount) {
        let positions = [0, 0, 0, 0];
        const horses = [0,1,2,3].map(i => document.getElementById('horse' + i));
        horses.forEach(h => h.style.left = '60px');

        const raceInterval = setInterval(() => {
            let winnerFound = false;
            const trackWidth = document.querySelector('.track').clientWidth - 100;

            for (let i = 0; i < 4; i++) {
                positions[i] += Math.floor(Math.random() * 16) + 3;
                horses[i].style.left = (60 + positions[i]) + 'px';
                if (positions[i] >= trackWidth) winnerFound = true;
            }

            if (winnerFound) {
                clearInterval(raceInterval);
                finishRace(positions, selectedHorse, betAmount);
            }
        }, 50);
    }

    function finishRace(positions, betChoice, betAmount) {
        const log = document.getElementById('gameLog');
        const rankArea = document.getElementById('rankingArea');
        
        // æ’åºæ’å
        const results = positions.map((pos, idx) => ({ id: idx + 1, pos: pos }))
                                 .sort((a, b) => b.pos - a.pos);

        const winnerId = results[0].id;
        const maxPos = results[0].pos;
        const winners = results.filter(r => r.pos === maxPos).map(r => r.id);

        let userWon = winners.includes(betChoice + 1);
        let winnerText = winners.map(id => id + "è™Ÿ").join(", ");

        if (userWon) {
            createConfetti(); drawConfetti();
            if (winners.length === 1) {
                playerMoney += betAmount;
                log.innerHTML = `<span style="color: #ffcc00">ğŸ† å† è»æ˜¯ ${winnerText}ï¼ä½ ç¨è´ $${betAmount}ï¼</span>`;
            } else {
                let halfWin = Math.floor(betAmount / 2);
                playerMoney += halfWin;
                log.innerHTML = `<span style="color: #ffcc00">ğŸ¤ å¹³æ‰‹ï¼å† è»æœ‰ ${winnerText}ï¼Œè´å¾— $${halfWin}</span>`;
            }
        } else {
            playerMoney -= betAmount;
            log.innerHTML = `<span style="color: #ff4d4d">ğŸ’¸ å† è»æ˜¯ ${winnerText}ï¼Œä¸‹æ¬¡å†ä¾†ï¼</span>`;
        }

        // é¡¯ç¤º 1~4 åæ’å
        rankArea.innerHTML = results.map((r, index) => {
            return `<div class="ranking-item">ç¬¬ ${index + 1} å: ${r.id} è™Ÿ</div>`;
        }).join("");

        document.getElementById('balance').innerText = playerMoney;
        isRacing = false;
        document.getElementById('startBtn').disabled = false;

        if (playerMoney <= 0) {
            log.innerHTML = "ğŸ’€ é¤˜é¡ç‚º 0ï¼Œä½ å·²ç ´ç”¢ï¼";
            document.getElementById('startBtn').disabled = true;
        }
    }
</script>

</body>
</html>